rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource (for existing documents)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is creating/updating with their own userId
    function isValidUserId(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate date format (YYYY-MM-DD)
    function isValidDate(dateString) {
      return dateString is string && 
             dateString.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
    }
    
    // Validate positive number
    function isPositiveNumber(value) {
      return value is number && value > 0;
    }
    
    // Validate non-negative number
    function isNonNegativeNumber(value) {
      return value is number && value >= 0;
    }
    
    // ============================================
    // Calorie Entries
    // ============================================
    match /calorieEntries/{entryId} {
      // Allow read if user owns the entry
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Allow create with validation
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       request.resource.data.food is string &&
                       request.resource.data.calories is number &&
                       request.resource.data.calories >= 0 &&
                       request.resource.data.mealType is string &&
                       request.resource.data.mealType in ['breakfast', 'lunch', 'dinner', 'snack'] &&
                       isValidDate(request.resource.data.date) &&
                       request.resource.data.createdAt is timestamp;
      
      // Allow update if user owns it and userId doesn't change
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.food is string &&
                       request.resource.data.calories is number &&
                       request.resource.data.calories >= 0 &&
                       request.resource.data.mealType is string &&
                       request.resource.data.mealType in ['breakfast', 'lunch', 'dinner', 'snack'] &&
                       isValidDate(request.resource.data.date);
      
      // Allow delete if user owns it
      allow delete: if isAuthenticated() && 
                        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Habits
    // ============================================
    match /habits/{habitId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       request.resource.data.color is string &&
                       (!('description' in request.resource.data) || 
                        request.resource.data.description is string) &&
                       request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       request.resource.data.color is string &&
                       (!('description' in request.resource.data) || 
                        request.resource.data.description is string);
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Habit Entries
    // ============================================
    match /habitEntries/{entryId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       request.resource.data.habitId is string &&
                       request.resource.data.habitId.size() > 0 &&
                       isValidDate(request.resource.data.date) &&
                       request.resource.data.completed is bool &&
                       request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.habitId == resource.data.habitId &&
                       request.resource.data.date == resource.data.date &&
                       request.resource.data.completed is bool &&
                       (!('createdAt' in request.resource.data) || 
                        request.resource.data.createdAt == resource.data.createdAt);
      
      allow delete: if isAuthenticated() && 
                        resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Workouts
    // ============================================
    match /workouts/{workoutId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       request.resource.data.type is string &&
                       request.resource.data.type in ['cardio', 'strength', 'flexibility', 'other'] &&
                       isValidDate(request.resource.data.date) &&
                       request.resource.data.createdAt is timestamp &&
                       (!('duration' in request.resource.data) || 
                        (request.resource.data.duration is number && 
                         request.resource.data.duration >= 0)) &&
                       (!('caloriesBurned' in request.resource.data) || 
                        (request.resource.data.caloriesBurned is number && 
                         request.resource.data.caloriesBurned >= 0)) &&
                       (!('weight' in request.resource.data) || 
                        (request.resource.data.weight is number && 
                         request.resource.data.weight > 0)) &&
                       (!('sets' in request.resource.data) || 
                        (request.resource.data.sets is number && 
                         request.resource.data.sets > 0)) &&
                       (!('reps' in request.resource.data) || 
                        (request.resource.data.reps is number && 
                         request.resource.data.reps > 0)) &&
                       (!('muscleGroups' in request.resource.data) || 
                        (request.resource.data.muscleGroups is list && 
                         request.resource.data.muscleGroups.size() <= 10)) &&
                       (!('exercise' in request.resource.data) || 
                        request.resource.data.exercise is string) &&
                       (!('routine' in request.resource.data) || 
                        request.resource.data.routine is string);
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       (!('name' in request.resource.data) || 
                        (request.resource.data.name is string && 
                         request.resource.data.name.size() > 0)) &&
                       (!('type' in request.resource.data) || 
                        (request.resource.data.type is string &&
                         request.resource.data.type in ['cardio', 'strength', 'flexibility', 'other'])) &&
                       (!('date' in request.resource.data) || 
                        isValidDate(request.resource.data.date)) &&
                       (!('duration' in request.resource.data) || 
                        (request.resource.data.duration is number && 
                         request.resource.data.duration >= 0)) &&
                       (!('caloriesBurned' in request.resource.data) || 
                        (request.resource.data.caloriesBurned is number && 
                         request.resource.data.caloriesBurned >= 0)) &&
                       (!('weight' in request.resource.data) || 
                        (request.resource.data.weight is number && 
                         request.resource.data.weight > 0)) &&
                       (!('sets' in request.resource.data) || 
                        (request.resource.data.sets is number && 
                         request.resource.data.sets > 0)) &&
                       (!('reps' in request.resource.data) || 
                        (request.resource.data.reps is number && 
                         request.resource.data.reps > 0)) &&
                       (!('muscleGroups' in request.resource.data) || 
                        (request.resource.data.muscleGroups is list && 
                         request.resource.data.muscleGroups.size() <= 10)) &&
                       (!('exercise' in request.resource.data) || 
                        request.resource.data.exercise is string) &&
                       (!('routine' in request.resource.data) || 
                        request.resource.data.routine is string);
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Goals
    // ============================================
    match /goals/{goalId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       request.resource.data.type is string &&
                       request.resource.data.type in ['calorie', 'workout', 'habit', 'weight'] &&
                       request.resource.data.target is number &&
                       request.resource.data.target > 0 &&
                       request.resource.data.period is string &&
                       request.resource.data.period in ['daily', 'weekly', 'monthly'] &&
                       isValidDate(request.resource.data.startDate) &&
                       request.resource.data.isActive is bool &&
                       request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       (!('type' in request.resource.data) || 
                        (request.resource.data.type == resource.data.type &&
                         request.resource.data.type is string &&
                         request.resource.data.type in ['calorie', 'workout', 'habit', 'weight'])) &&
                       (!('target' in request.resource.data) || 
                        (request.resource.data.target is number && 
                         request.resource.data.target > 0)) &&
                       (!('period' in request.resource.data) || 
                        (request.resource.data.period is string &&
                         request.resource.data.period in ['daily', 'weekly', 'monthly'])) &&
                       (!('startDate' in request.resource.data) || 
                        isValidDate(request.resource.data.startDate)) &&
                       (!('isActive' in request.resource.data) || 
                        request.resource.data.isActive is bool);
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Weight Entries
    // ============================================
    match /weightEntries/{entryId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       isValidDate(request.resource.data.date) &&
                       request.resource.data.weight is number &&
                       request.resource.data.weight > 0 &&
                       request.resource.data.weight <= 1000 &&
                       request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.date == resource.data.date &&
                       request.resource.data.weight is number &&
                       request.resource.data.weight > 0 &&
                       request.resource.data.weight <= 1000;
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Water Entries
    // ============================================
    match /waterEntries/{entryId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       isValidDate(request.resource.data.date) &&
                       request.resource.data.amount is number &&
                       request.resource.data.amount > 0 &&
                       request.resource.data.amount <= 10000 &&
                       request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.date == resource.data.date &&
                       request.resource.data.amount is number &&
                       request.resource.data.amount > 0 &&
                       request.resource.data.amount <= 10000;
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Body Measurements
    // ============================================
    match /bodyMeasurements/{measurementId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       isValidDate(request.resource.data.date) &&
                       request.resource.data.createdAt is timestamp &&
                       (!('waist' in request.resource.data) || 
                        (request.resource.data.waist is number && 
                         request.resource.data.waist > 0 && 
                         request.resource.data.waist <= 500)) &&
                       (!('chest' in request.resource.data) || 
                        (request.resource.data.chest is number && 
                         request.resource.data.chest > 0 && 
                         request.resource.data.chest <= 500)) &&
                       (!('arms' in request.resource.data) || 
                        (request.resource.data.arms is number && 
                         request.resource.data.arms > 0 && 
                         request.resource.data.arms <= 200)) &&
                       (!('thighs' in request.resource.data) || 
                        (request.resource.data.thighs is number && 
                         request.resource.data.thighs > 0 && 
                         request.resource.data.thighs <= 200)) &&
                       (!('hips' in request.resource.data) || 
                        (request.resource.data.hips is number && 
                         request.resource.data.hips > 0 && 
                         request.resource.data.hips <= 500)) &&
                       (!('neck' in request.resource.data) || 
                        (request.resource.data.neck is number && 
                         request.resource.data.neck > 0 && 
                         request.resource.data.neck <= 200));
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       (!('date' in request.resource.data) || 
                        (request.resource.data.date == resource.data.date &&
                         isValidDate(request.resource.data.date)));
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // User Settings
    // Document ID must match userId
    // ============================================
    match /userSettings/{settingsId} {
      // Allow read if document ID matches user's ID
      allow read: if isAuthenticated() && 
                     request.auth.uid == settingsId;
      
      // Allow create if document ID matches user's ID and userId field matches
      allow create: if isAuthenticated() &&
                       request.auth.uid == settingsId &&
                       request.resource.data.userId == settingsId &&
                       request.resource.data.userId == request.auth.uid &&
                       (!('darkMode' in request.resource.data) || 
                        request.resource.data.darkMode is bool) &&
                       (!('notificationsEnabled' in request.resource.data) || 
                        request.resource.data.notificationsEnabled is bool) &&
                       (!('onboardingCompleted' in request.resource.data) || 
                        request.resource.data.onboardingCompleted is bool) &&
                       (!('bodyGoal' in request.resource.data) || 
                        request.resource.data.bodyGoal is string) &&
                       (!('profile' in request.resource.data) || 
                        request.resource.data.profile is map) &&
                       (!('dailyCalorieTarget' in request.resource.data) || 
                        (request.resource.data.dailyCalorieTarget is number && 
                         request.resource.data.dailyCalorieTarget > 0 && 
                         request.resource.data.dailyCalorieTarget <= 10000)) &&
                       (!('reminderTimes' in request.resource.data) || 
                        request.resource.data.reminderTimes is map) &&
                       (!('weeklyReminders' in request.resource.data) || 
                        request.resource.data.weeklyReminders is map) &&
                       (!('units' in request.resource.data) || 
                        request.resource.data.units is map) &&
                       (!('workoutRoutines' in request.resource.data) || 
                        request.resource.data.workoutRoutines is list) &&
                       request.resource.data.updatedAt is timestamp;
      
      // Allow update if document ID matches user's ID and userId cannot be changed
      allow update: if isAuthenticated() &&
                       request.auth.uid == settingsId &&
                       resource.data.userId == settingsId &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.userId == request.auth.uid &&
                       (!('darkMode' in request.resource.data) || 
                        request.resource.data.darkMode is bool) &&
                       (!('notificationsEnabled' in request.resource.data) || 
                        request.resource.data.notificationsEnabled is bool) &&
                       (!('onboardingCompleted' in request.resource.data) || 
                        request.resource.data.onboardingCompleted is bool) &&
                       (!('bodyGoal' in request.resource.data) || 
                        request.resource.data.bodyGoal is string) &&
                       (!('profile' in request.resource.data) || 
                        request.resource.data.profile is map) &&
                       (!('dailyCalorieTarget' in request.resource.data) || 
                        (request.resource.data.dailyCalorieTarget is number && 
                         request.resource.data.dailyCalorieTarget > 0 && 
                         request.resource.data.dailyCalorieTarget <= 10000)) &&
                       (!('reminderTimes' in request.resource.data) || 
                        request.resource.data.reminderTimes is map) &&
                       (!('weeklyReminders' in request.resource.data) || 
                        request.resource.data.weeklyReminders is map) &&
                       (!('units' in request.resource.data) || 
                        request.resource.data.units is map) &&
                       (!('workoutRoutines' in request.resource.data) || 
                        request.resource.data.workoutRoutines is list) &&
                       (!('updatedAt' in request.resource.data) || 
                        request.resource.data.updatedAt is timestamp);
      
      // Allow delete if document ID matches user's ID
      allow delete: if isAuthenticated() && 
                       request.auth.uid == settingsId;
    }
    
    // ============================================
    // Meal Plans
    // ============================================
    match /mealPlans/{planId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       isValidDate(request.resource.data.date) &&
                       request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       (!('date' in request.resource.data) || 
                        (request.resource.data.date == resource.data.date &&
                         isValidDate(request.resource.data.date)));
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Workout Plans
    // ============================================
    match /workoutPlans/{planId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       request.resource.data.createdAt is timestamp;
      
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == resource.data.userId &&
                       (!('name' in request.resource.data) || 
                        (request.resource.data.name is string && 
                         request.resource.data.name.size() > 0));
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // Achievements
    // ============================================
    match /achievements/{achievementId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() &&
                       isValidUserId(request.resource.data.userId) &&
                       request.resource.data.userId is string &&
                       request.resource.data.type is string &&
                       request.resource.data.type.size() > 0 &&
                       request.resource.data.title is string &&
                       request.resource.data.title.size() > 0 &&
                       request.resource.data.unlockedAt is timestamp;
      
      // Achievements should not be updated or deleted by users
      // They are system-generated
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // Deny all other collections
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
